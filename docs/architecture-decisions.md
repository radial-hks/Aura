# 架构决策记录 (ADR)

本文档记录了 Aura 系统的关键架构决策，包括决策背景、考虑因素、最终决策和影响。

## ADR-001: 混合智能架构

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 架构团队

### 背景

需要在AI的灵活性和脚本的可靠性之间找到平衡，既要处理复杂的动态场景，又要保证高频操作的稳定性。

### 决策

保留"AI动态规划 + 固定脚本"双模式，新增 Orchestrator、Policy Engine、Skill Library、Site Model Registry。

### 理由

- **灵活性**: AI模式处理未知和复杂场景
- **可靠性**: 脚本模式保证已知场景的稳定执行
- **可扩展性**: 模块化设计便于功能扩展
- **可维护性**: 清晰的职责分离

### 后果

- ✅ 提高了系统的扩展性和风险可控性
- ✅ 具备可持续迭代的基础
- ❌ 架构复杂度增加
- ❌ 开发和维护成本上升

---

## ADR-002: Action Graph 执行模型

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 技术团队

### 背景

需要一种标准化的方式来表示和执行复杂的浏览器操作序列，确保操作的可验证性、可重放性和可迁移性。

### 决策

AI 输出先转化为 Action Graph（DAG），再执行。

### 理由

- **可验证性**: 执行前可以验证操作的合法性
- **可重放性**: 支持操作的重复执行和调试
- **可迁移性**: 操作序列可以在不同环境间迁移
- **可观测性**: 便于监控和分析执行过程

### 后果

- ✅ 形成了稳定的执行基座
- ✅ 支持复杂的操作编排
- ❌ 需要设计Schema和编译器
- ❌ 增加了系统复杂度

---

## ADR-003: 技能包 (Skill Pack) 系统

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 产品团队

### 背景

固定脚本系统需要升级，支持更丰富的元数据、参数验证、断言检查和可观测性。

### 决策

固定脚本系统升级为 Skill Pack（Manifest + 参数Schema + 断言 + 可观测性）。

### 理由

- **标准化**: 统一的技能包格式
- **可复用性**: 技能包可以跨项目复用
- **质量保证**: 内置断言和验证机制
- **生态建设**: 支持技能包的分享和评级

### 后果

- ✅ 形成标准化技能生态
- ✅ 提高技能包质量
- ❌ 需要注册中心与沉淀流水线
- ❌ 增加技能包开发复杂度

---

## ADR-004: Site Model Registry

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 技术团队

### 背景

网站结构经常变化，需要一种机制来管理网站模型的版本化和更新，抵抗选择器漂移问题。

### 决策

探索结果存入模型仓库（语义定位符+版本化）。

### 理由

- **抗漂移**: 语义定位符比CSS选择器更稳定
- **版本管理**: 支持模型的版本化和回滚
- **增量更新**: 支持模型的增量更新
- **共享复用**: 模型可以跨任务复用

### 后果

- ✅ 抗选择器漂移，提高稳定性
- ✅ 支持增量更新与回滚
- ❌ 需要存储与TTL治理
- ❌ 增加系统复杂度

---

## ADR-005: Policy & Risk Engine

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 安全团队

### 背景

自动化操作可能涉及敏感数据和高风险操作，需要建立安全防护机制。

### 决策

高风险操作强制走策略引擎，支持人工审核和多因子认证。

### 理由

- **安全合规**: 满足企业安全要求
- **风险控制**: 防止恶意或错误操作
- **审计跟踪**: 完整的操作审计日志
- **灵活配置**: 支持不同级别的安全策略

### 后果

- ✅ 确保系统安全合规
- ✅ 降低操作风险
- ❌ 可能增加交互摩擦
- ❌ 增加系统复杂度

---

## ADR-006: Observability & Replay

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 运维团队

### 背景

需要完整的可观测性支持，便于问题诊断、性能优化和合规审计。

### 决策

执行链全量日志+截图+回放。

### 理由

- **问题诊断**: 详细日志便于问题定位
- **性能优化**: 性能数据支持系统优化
- **合规审计**: 满足审计要求
- **用户体验**: 可视化执行过程

### 后果

- ✅ 调试与审计友好
- ✅ 支持性能优化
- ❌ 增加存储成本
- ❌ 可能影响执行性能

---

## ADR-007: MCP 协议集成

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 架构团队

### 背景

需要与多种外部服务和工具集成，包括浏览器自动化、文件系统、搜索引擎等。

### 决策

采用 MCP (Model Context Protocol) 作为统一的集成协议。

### 理由

- **标准化**: 统一的协议接口
- **可扩展性**: 易于集成新的服务
- **互操作性**: 与其他MCP兼容系统互通
- **社区支持**: 活跃的开源社区

### 后果

- ✅ 统一的集成架构
- ✅ 易于扩展新功能
- ❌ 依赖外部协议标准
- ❌ 需要学习新的协议

---

## ADR-008: 微服务架构

**状态**: 考虑中  
**日期**: 2024-01  
**决策者**: 架构团队

### 背景

随着系统功能增加，单体架构可能面临扩展性和维护性挑战。

### 选项

1. **保持单体架构**: 简单直接，适合当前规模
2. **微服务架构**: 更好的扩展性，但增加复杂度
3. **模块化单体**: 折中方案，保持单体但模块化

### 当前倾向

模块化单体架构，在保持简单性的同时提供良好的模块化。

### 待决策因素

- 团队规模和技术能力
- 系统负载和性能要求
- 部署和运维复杂度

---

## ADR-009: 数据存储策略

**状态**: 已采纳  
**日期**: 2024-01  
**决策者**: 技术团队

### 背景

系统需要存储多种类型的数据，包括配置、日志、模型、会话等。

### 决策

采用多存储策略：
- **SQLite/PostgreSQL**: 结构化数据
- **Redis**: 缓存和会话
- **文件系统**: 大文件和日志
- **内存**: 临时数据

### 理由

- **性能优化**: 不同存储适合不同场景
- **成本控制**: 避免过度工程
- **简单性**: 减少外部依赖
- **可扩展性**: 支持后续升级

### 后果

- ✅ 平衡性能和复杂度
- ✅ 适合不同数据类型
- ❌ 需要管理多种存储
- ❌ 数据一致性挑战

---

## 决策原则

在做架构决策时，我们遵循以下原则：

1. **简单性优先**: 在满足需求的前提下选择最简单的方案
2. **可扩展性**: 设计要考虑未来的扩展需求
3. **可维护性**: 代码和架构要易于理解和维护
4. **性能平衡**: 在性能和复杂度之间找到平衡
5. **安全第一**: 安全考虑贯穿整个设计过程
6. **用户体验**: 技术决策要服务于用户体验

## 决策流程

1. **问题识别**: 明确需要决策的问题
2. **选项分析**: 列出可能的解决方案
3. **影响评估**: 评估每个选项的影响
4. **团队讨论**: 团队充分讨论和评估
5. **决策记录**: 记录决策和理由
6. **定期回顾**: 定期回顾和调整决策

---

> 📖 **相关文档**
> - [系统概览](./system-overview.md)
> - [技术规范](./technical-specifications.md)
> - [开发指南](./development-guide.md)